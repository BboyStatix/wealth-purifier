<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Wealth Purifier</title>
</head>
<body>
  <form onsubmit="uploadFiles(event)">
    <div>
      <label for="statementType">Statement Type</label>
      <select id="statementType" name="statementType">
        <option value="hsbc_one">HSBC One(HKD, USD)</option>
        <option value="hsbc_statement_savings">HSBC Statement Savings</option>
        <option value="mox">Mox</option>
      </select>
    </div>

    <div>
      <label for="statements">Attach your bank statements:</label>
      <input type="file" id="statements" name="statements" multiple>
    </div>

    <button type="submit">Calculate Interest</button>
  </form>
  <div id="loadingMessage" style="display: none;">Generating report...</div>

  <div id="report"></div>

  <script>
    const GENERATE_REPORT_URL = "https://wealth-purifier.vercel.app/report/generate"
    const SERVERLESS_FN_FILE_LIMIT = 5

    reportSection = document.getElementById('report')
    const loadingMessage = document.getElementById('loadingMessage')
    const statementTypeInput = document.getElementById('statementType');
    const statementsInput = document.getElementById('statements');

    function resetReport() {
      reportSection.innerHTML = ""
    }

    function displayGeneratedReport(interestEntries) {
      let total = 0
      for([date, interestAmount] of interestEntries) {
        const div = document.createElement('div')
        div.textContent = `${date}: ${interestAmount}`
        reportSection.appendChild(div)
        total += interestAmount
      }
      const totalDiv = document.createElement('div')
      totalDiv.textContent = `Total: ${total}`
      reportSection.appendChild(totalDiv)
    }

    function setLoadingMessage(display) {
      if(display) {
        loadingMessage.style.display = 'block'
      } else {
        loadingMessage.style.display = 'none'
      }
    }

    async function generateReport(files) {
      var formData = new FormData();
      for (file of files) {
        formData.append('files', file);
      }
      formData.append('statementType', statementTypeInput.value);

      return fetch(GENERATE_REPORT_URL, {
        method: 'POST',
        body: formData
      })
      .then(function(response) {
        if (response.ok) return response.json()
        throw new Error("Failed to submit!")
      })
      .catch(function(error) {
        console.log('Error:', error);
        alert('An error occurred.');
      })
    }

    async function uploadFiles(e) {
      e.preventDefault();

      resetReport()
      setLoadingMessage(true)

      numOfElemsToSlice = SERVERLESS_FN_FILE_LIMIT
      files = Object.values(statementsInput.files)
      const generateReportPromises = []
      for (let startIdx = 0; startIdx < files.length; startIdx += numOfElemsToSlice) {
        const slicedFiles = files.slice(startIdx, startIdx + numOfElemsToSlice)
        const generateReportPromise = generateReport(slicedFiles)
        generateReportPromises.push(generateReportPromise)
      }
      const responses = await Promise.all(generateReportPromises)
      const interestEntries = responses.flat()
      displayGeneratedReport(interestEntries)

      setLoadingMessage(false)
    }
  </script>
</body>
</html>