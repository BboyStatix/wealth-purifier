<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Wealth Purifier</title>
</head>
<body style="text-align: center;">
  <h2>Wealth Purifier</h2>
  <form onsubmit="calculateInterest(event)">
    <div>
      <label for="statementType">Statement Type</label>
      <select id="statementType" name="statementType">
        <option value="hsbc_one">HSBC One(HKD, USD)</option>
        <option value="hsbc_statement_savings">HSBC Statement Savings</option>
        <option value="mox">Mox</option>
      </select>
    </div>

    <div style="margin-top: 12px;">
      <label for="statements">Attach your bank statements:</label>
      <input type="file" id="statements" name="statements" multiple>
    </div>

    <div style="margin-top: 12px;">
      <button type="submit">Calculate Interest</button>
    </div>
  </form>
  <div id="loadingMessage" style="display: none;margin-top: 12px;">Generating report...</div>

  <table 
    id="report" 
    style="
      display: none;
      text-align: left;
      margin-top: 12px;
      margin-left: auto;
      margin-right: auto;"
    >
    <thead>
      <tr>
        <th>Date</th>
        <th>Amount</th>
      </tr>
    </thead>
    <tbody>
    </tbody>
  </table>

  <script>
    const GENERATE_REPORT_URL = "https://wealth-purifier.vercel.app/report/generate"
    const SERVERLESS_FN_FILE_LIMIT = 5

    const reportSection = document.getElementById('report')
    const tbody = reportSection.getElementsByTagName('tbody')[0]

    const loadingMessage = document.getElementById('loadingMessage')
    const statementTypeInput = document.getElementById('statementType');
    const statementsInput = document.getElementById('statements');

    function resetReport() {
      reportSection.style.display = "none"
      tbody.innerHTML = ''
    }

    function displayGeneratedReport(interestEntries) {
      reportSection.style.display = "inline-block"

      let total = 0
      for([date, interestAmount] of interestEntries) {
        const tr = document.createElement('tr')

        let td = document.createElement('td')
        td.textContent = date
        tr.appendChild(td)

        td = document.createElement('td')
        td.textContent = interestAmount
        tr.appendChild(td)

        tbody.appendChild(tr)
        total += interestAmount
      }
      const totalRow = document.createElement('tr')
      let td = document.createElement('td')
      td.innerHTML = '<strong>Total</strong>'
      totalRow.appendChild(td)

      td = document.createElement('td')
      td.textContent = total
      totalRow.appendChild(td)

      tbody.appendChild(totalRow)
    }

    function setLoadingMessage(display) {
      if(display) {
        loadingMessage.style.display = 'block'
      } else {
        loadingMessage.style.display = 'none'
      }
    }

    async function submitFiles(files) {
      var formData = new FormData();
      for (file of files) {
        formData.append('files', file);
      }
      formData.append('statementType', statementTypeInput.value);

      return fetch(GENERATE_REPORT_URL, {
        method: 'POST',
        body: formData
      })
      .then(function(response) {
        if (response.ok) return response.json()
        throw new Error("Failed to submit!")
      })
      .catch(function(error) {
        console.log('Error:', error);
        alert('An error occurred.');
      })
    }

    const batched = ({batchSize, items}) => cb => {
      const promises = []
      for (let startIdx = 0; startIdx < items.length; startIdx += batchSize) {
        const currentBatchOfItems = items.slice(startIdx, startIdx + batchSize)
        promises.push(cb(currentBatchOfItems))
      }
      return promises
    }

    async function calculateInterest(e) {
      e.preventDefault();

      resetReport()
      setLoadingMessage(true)

      files = Object.values(statementsInput.files)
      const inBatchesOfN = batched({ batchSize: SERVERLESS_FN_FILE_LIMIT, items: files })
      const responses = await Promise.all(inBatchesOfN(submitFiles))
      const interestEntries = responses.flat()
      displayGeneratedReport(interestEntries)

      setLoadingMessage(false)
    }
  </script>
</body>
</html>